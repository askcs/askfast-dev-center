define(["services/services"],function(e){e.factory("Store",["$window","$log","$parse",function(e,t,n){return function(r,i){function c(e){try{return a(e)}catch(t){return null}}function h(e){return new Lawnchair({name:r},e)}function p(n,r){r=r.toString(),angular.isObject(n)&&n!==s[r]?(s[r]=s[r]||{},angular.extend(s[r],n)):s[r]=n;var i={key:r,value:f(s[r])};try{h(function(){this.save(i)})}catch(o){(o.name==="QUOTA_EXCEEDED_ERR"||o.name==="NS_ERROR_DOM_QUOTA_REACHED")&&e.localStorage.clear(),t.info("LocalStorage Exception ==> "+o.message)}}function d(e){return o.length=0,_.each(e,function(e){o.push(e)}),o}function v(e,t){e&&angular.isObject(e)&&s[t]&&s[t]!==e?angular.extend(s[t],e):s[t]=e}function m(e,t){return t&&(angular.isObject(t.value)&&angular.isObject(e)?angular.extend(e,l(t.value)):e=l(t.value),v(e,t.key)),e}function g(e){return h(function(){this.all(function(t){angular.forEach(t,function(e){v(e.value,e.key)}),e&&e(s)})}),s}function y(e){return d(g(function(t){d(t),e&&e(o)}))}function b(e){delete s[e],h(function(){this.remove(e)})}function w(e){if(s[e])return s[e];var t={};return a.assign(t,e),t}var s={},o=[],u=i&&i.isArray,a=n(i&&i.entryKey?i.entryKey:"id"),f=i&&i.transformSave?i.transformSave:angular.identity,l=i&&i.transformLoad?i.transformLoad:angular.identity,E={collection:s,save:function(e,t,n){e||(e=s,t=null),angular.isArray(e)?angular.forEach(e,function(e,t){p(e,c(e)||t)}):t||e&&c(e)?p(e,t||c(e)):angular.forEach(e,p);if(n){var r=angular.isArray(e)?_.chain(e).map(c).map(String).value():_.keys(e);_.chain(s).keys().difference(r).each(b),_.chain(s).filter(function(e){return!c(e)}).keys().each(b)}u&&d(s)},batch:function(e,t,n){var r=_.chain(e).map(function(e){return w(e)}).value();return t&&angular.isArray(t)?(t.length=0,_.each(r,function(e){t.push(e)})):t=r,h(function(){this.get(e,function(e){if(e)for(var r=e.length-1;r>=0;r--)t[r]=m(t[r],e[r]);n&&n(t)})}),t},get:function(e,t){var n=w(e);return h(function(){this.get(e,function(e){e&&(n=m(n,e)),t&&t(n)})}),n},all:u?y:g,remove:b,nuke:function(){h(function(){this.nuke()})},destroy:function(){for(var e in s)delete s[e];h(function(){this.nuke()})}};return E}}])});