define(["services/services"],function(e){"use strict";e.factory("Store",["$window","$log","$parse",function(e,t,n){return function(r,i){var s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E;return h=function(e){try{return p(e)}catch(t){return null}},s=function(e){return new Lawnchair({name:r},e)},m=function(n,r){var i;r=r.toString(),angular.isObject(n)&&n!==l[r]?(l[r]=l[r]||{},angular.extend(l[r],n)):l[r]=n,i={key:r,value:y(l[r])};try{s(function(){this.save(i)})}catch(o){(o.name==="QUOTA_EXCEEDED_ERR"||o.name==="NS_ERROR_DOM_QUOTA_REACHED")&&e.localStorage.clear(),t.info("LocalStorage Exception ==> "+o.message)}},b=function(e){return f.length=0,_.each(e,function(e){f.push(e)}),f},w=function(e,t){e&&angular.isObject(e)&&l[t]&&l[t]!==e?angular.extend(l[t],e):l[t]=e},E=function(e,t){return t&&(angular.isObject(t.value)&&angular.isObject(e)?angular.extend(e,g(t.value)):e=g(t.value),w(e,t.key)),e},a=function(e){return s(function(){this.all(function(t){angular.forEach(t,function(e){w(e.value,e.key)}),e&&e(l)})}),l},u=function(e){return b(a(function(t){b(t),e&&e(f)}))},v=function(e){delete l[e],s(function(){this.remove(e)})},c=function(e){var t;return l[e]?l[e]:(t={},p.assign(t,e),t)},l={},f=[],d=i&&i.isArray,p=n(i&&i.entryKey?i.entryKey:"id"),y=i&&i.transformSave?i.transformSave:angular.identity,g=i&&i.transformLoad?i.transformLoad:angular.identity,o={collection:l,save:function(e,t,n){var r;e||(e=l,t=null),angular.isArray(e)?angular.forEach(e,function(e,t){m(e,h(e)||t)}):t||e&&h(e)?m(e,t||h(e)):angular.forEach(e,m),n&&(r=angular.isArray(e)?_.chain(e).map(h).map(String).value():_.keys(e),_.chain(l).keys().difference(r).each(v),_.chain(l).filter(function(e){return!h(e)}).keys().each(v)),d&&b(l)},batch:function(e,t,n){var r;return r=_.chain(e).map(function(e){return c(e)}).value(),t&&angular.isArray(t)?(t.length=0,_.each(r,function(e){t.push(e)})):t=r,s(function(){this.get(e,function(e){var r;if(e){r=e.length-1;while(r>=0)t[r]=E(t[r],e[r]),r--}n&&n(t)})}),t},get:function(e,t){var n;return n=c(e),s(function(){this.get(e,function(e){e&&(n=E(n,e)),t&&t(n)})}),n},all:d?u:a,remove:v,nuke:function(){s(function(){this.nuke()})},destroy:function(){var e;for(e in l)delete l[e];s(function(){this.nuke()})}},o}}])});