define(["require","exports","services/services"],function(e,t,n){var r=function(){function e(e,t,n,r){this.adapterTypes={call:{label:"Phone",ids:[]},xmpp:{label:"Gtalk",ids:[]},email:{label:"Email",ids:[]},twitter:{label:"Twitter",ids:[]},sms:{label:"SMS",ids:[]}},this.q=e,this.AskFast=t,this.Store=n,this.moment=r}return e.prototype.list=function(e,t){var n=this,r=this.q.defer();return this.AskFast.caller("ddr",{limit:e,endTime:t}).then(function(e){var t=n.Store("data").get("ddrTypes"),i=n.Store("data").get("adapterMap"),s={call:[],email:[],sms:[],xmpp:[],twitter:[],other:[]},o=[];angular.forEach(e,function(e){o.push(n.processDdr(e,t,i))}),angular.forEach(o,function(e){var t=!1;angular.forEach(i,function(n,r){e.adapterId==r&&s[i[e.adapterId]]&&(s[i[e.adapterId]].push(e),t=!0)}),t||s.other.push(e)}),n.data=s,r.resolve(n.categorize())}).catch(function(e){r.reject(e)}),r.promise},e.prototype.categorize=function(e){if(e&&e!=="all")return this.data[e];var t=[],n=this.data;return angular.forEach(n,function(e){angular.forEach(e,function(e){t.push(e)})}),t},e.prototype.detail=function(e){var t=this,n=this.q.defer(),r=this.Store("data").get("ddrTypes"),i=this.Store("data").get("adapterMap");return this.q.all([this.AskFast.caller("ddrRecord",{second:e}),this.AskFast.caller("httpLog",{second:e})]).then(function(n){var r=t.q.defer();return angular.equals([],n[1])?t.AskFast.caller("log",{ddrRecordId:e}).then(function(e){n[1]=e,r.resolve(n)}).catch(function(e){console.warn("error ",e),r.reject(e)}):r.resolve(n),r.promise}).then(function(e){function u(e){e.timestamp?e.timeString=this.moment(e.timestamp).format("HH:mm:ss Z YYYY-MM-DD"):e.requestLog&&e.requestLog.timestamp?(e.timestamp=e.requestLog.timestamp,e.timeString=this.moment(e.requestLog.timestamp).format("HH:mm:ss Z YYYY-MM-DD")):e.timeString="Missing timestamp",e.requestLog&&(angular.equals({},e.requestLog.headers)&&(e.requestLog.headers=null),angular.forEach(e.requestLog.parameters,function(t,n){switch(t){case null:e.requestLog.parameters[n]="null";break;case undefined:e.requestLog.parameters[n]="undefined"}}))}var s=t.processDdr(e[0],r,i),o=e[1];angular.forEach(o,function(e){u(e)}),n.resolve([s,o])}).catch(function(e){console.warn(e),n.reject(e)}),n.promise},e.prototype.processDdr=function(e,t,n){return e.start?(e.startString=this.moment(e.start).format("HH:mm:ss Z YYYY-MM-DD"),e.duration!==null?e.endString=this.moment(e.start+e.duration).format("HH:mm:ss Z YYYY-MM-DD"):e.endString="-"):(e.startString="-",e.endString="-"),e.fromAddress=e.fromAddress||"-",e.toAddress=e.toAddressString?Object.keys(angular.fromJson(e.toAddressString))[0]:"-",e.ddrTypeString=e.ddrTypeId?this.getDdrTypeString(e.ddrTypeId,t):"-",e.statusPerAddress&&angular.forEach(e.statusPerAddress,function(t,n){e.statusPerAddress[n]={index:n,status:t}}),e.adapterTypeString=e.adapterId?this.getAdapterTypeString(e.adapterId,n):"-",e},e.prototype.getDdrTypeString=function(e,t){return typeof t[e]!="undefined"&&typeof t[e].categoryString!="undefined"?t[e].categoryString:"Unknown"},e.prototype.getAdapterTypeString=function(e,t){return typeof t[e]!="undefined"?this.adapterTypes[t[e]].label:"Unknown"},e.$inject=["$q","AskFast","Store","moment"],e}();n.service("LogsService",r)});