define(["controllers/controllers","modals/askfast"],function(e,t){e.controller("user",["$scope","$rootScope","AskFast","Session","Store","$location","MD5",function(e,t,n,r,i,s,o){e.login={email:"",password:"",validation:{email:!1,password:!1},error:{state:!1,code:null},state:!1};var u=angular.element("#login button[type=submit]"),a=i("app").get("login");a&&a.remember&&(e.login.email=a.email,e.login.password=a.password,e.login.remember=a.remember),e.auth=function(){u.text("Login..").attr("disabled","disabled"),i("app").save({login:{email:e.login.email,password:e.login.password,remember:e.login.remember}}),n.caller("login",{username:e.login.email,password:o(e.login.password)},null,{success:function(o){o.hasOwnProperty("X-SESSION_ID")&&(e.login.error={state:!1,code:null},r.set(o["X-SESSION_ID"]),e.login.state=!0,n.caller("info").then(function(e){n.caller("key").then(function(n){n.accountId==e.id&&(e.refreshToken=n.refreshToken),i("app").save({user:e}),t.user=e,angular.element("body").removeClass().css({backgroundColor:"#454545"}),s.search().redirect_url?window.location.href=s.search().redirect_url:s.path("/dashboard")})}))},error:function(t){[400,403,404,500].indexOf(t.status)>=0&&(console.log("falling in"),e.login.error={state:!0,code:t.status},console.warn("login error ->",e.login.error),u.text("Login").removeAttr("disabled"))}})},e.logout=function(){r.clear(),n.caller("logout").then(function(){s.path("/login")})},e.data={user:{name:{first:"",last:"",full:function(){return this.first+" "+this.last}},email:"",phone:""},passwords:{first:"",second:""},verification:{id:null,code:null,resent:!1},agreed:!1,validation:{name:{first:!1,last:!1},email:!1,userExists:!1,passwords:!1,phone:!1},submitted:!1,error:{register:!1,resent:!1,verify:!1}},e.step={value:null,resolve:Number(s.hash().split("-")[1]),check:function(e){return this.value===e},validate:function(t){var n=!0;switch(t){case 1:e.data.submitted=!0,e.data.validation.name.first=e.data.user.name.first=="",e.data.validation.name.last=e.data.user.name.last=="",e.data.validation.email=e.data.user.email=="",e.data.validation.passwords=e.data.passwords.first==""||e.data.passwords.second==""||e.data.passwords.first!=e.data.passwords.second;if(e.data.validation.first||e.data.validation.last||e.data.validation.email||e.data.validation.userExists||e.data.validation.passwords||!e.data.agreed)n=!1;break;case 2:break;case 3:break;default:}return n},forward:function(){var t=this.value,n=angular.element("body");n.removeClass();switch(t){case 1:n.addClass("register-0");break;case 2:n.addClass("register-1");break;case 3:n.addClass("register-2");break;case 4:n.addClass("register-3")}this.validate(t)&&(this.value=Number(t+1),s.hash("step-"+this.value)),e.data.verification.resent=!1,e.data.error.register=!1,e.data.error.resent=!1,e.data.error.verify=!1}},localStorage.hasOwnProperty("data.verification.id")&&(e.step.value=3,s.hash("step-3")),e.step.value=e.step.resolve,e.register=function(){n.caller("register",{name:e.data.user.name.full(),username:e.data.user.email,email:e.data.user.email,password:e.data.passwords.first,phone:e.data.user.phone,verification:"SMS"}).then(function(t){t.hasOwnProperty("error")?e.data.error.register=!0:(e.data.verification.id=t.verificationCode,localStorage.setItem("data.verification.id",t.verificationCode))})};var f=500;e.userExists=function(){e.checkUsername&&(clearTimeout(e.checkUsername),e.checkUsername=null),e.checkUsername=setTimeout(function(){e.checkUsername=null,e.registrationForm1.email.$valid&&n.caller("userExists",{username:e.data.user.email}).then(function(t){e.data.validation.userExists=t.hasOwnProperty("error")})},f)},e.checkUsername=null,e.verify=function(){n.caller("registerVerify",{code:e.data.verification.code,id:localStorage.getItem("data.verification.id")}).then(function(t){t.hasOwnProperty("error")?(e.data.verification.resent=!1,e.data.error.verify=!0):(localStorage.removeItem("data.verification.id"),e.step.forward(),e.sessionId=t["X-SESSION_ID"])})},e.resend=function(){n.caller("resendVerify",{code:localStorage.getItem("data.verification.id"),verification:"SMS"}).then(function(t){t.hasOwnProperty("error")?e.data.error.resent=!0:(e.data.verification.resent=!0,e.data.error.verify=!1)})},e.bootstrap=function(){r.set(e.sessionId,!0),n.caller("info").then(function(e){i("app").save({user:e}),t.user=e,s.path("/home")})}}])});