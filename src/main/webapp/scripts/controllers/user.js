define(["controllers/controllers","modals/askfast"],function(e,t){"use strict";e.controller("user",["$scope","$rootScope","$routeParams","AskFast","Session","Store","$location","MD5",function(e,t,n,r,i,s,o,u){var a,f;e.login={email:"",password:"",validation:{email:!1,password:!1},error:{state:!1,code:null},state:!1,forgot:!1,changePass:!1,notification:""},n.code&&n.id&&(a=n.id,f=n.code,e.login.changePass=!0);var l=angular.element("#login button[type=submit]"),c=s("app").get("login");c&&c.remember&&(e.login.email=c.email,e.login.password=c.password,e.login.remember=c.remember),e.auth=function(){l.text("Login..").attr("disabled","disabled"),s("app").save({login:{email:e.login.email,password:e.login.password,remember:e.login.remember}}),r.caller("login",{username:e.login.email,password:u(e.login.password)},null,{success:function(n){n.hasOwnProperty("X-SESSION_ID")&&(e.login.error={state:!1,code:null},i.set(n["X-SESSION_ID"]),e.login.state=!0,r.caller("info").then(function(e){r.caller("getAdapters").then(function(n){var i={};angular.forEach(n,function(e){i[e.configId]=e.adapterType}),s("adatperMap").save(i),s("adapters").save(n),r.caller("key").then(function(n){n.accountId==e.id&&(e.refreshToken=n.refreshToken),s("app").save({user:e}),t.user=e,angular.element("body").removeClass().css({backgroundColor:"#454545"}),o.search().redirect_url?window.location.href=o.search().redirect_url:o.path("/dashboard")})})}))},error:function(t){[400,403,404,500].indexOf(t.status)>=0&&(console.log("falling in"),e.login.error={state:!0,code:t.status},console.warn("login error ->",e.login.error),l.text("Login").removeAttr("disabled"))}})},e.logout=function(){i.clear(),r.caller("logout").then(function(){o.path("/login")})},e.data={user:{name:{first:"",last:"",full:function(){return this.first+" "+this.last}},email:"",phone:""},passwords:{first:"",second:""},verification:{id:null,code:null,resent:!1},agreed:!1,validation:{name:{first:!1,last:!1},email:!1,userExists:!1,passwords:!1,phone:!1},submitted:!1,error:{register:!1,resent:!1,verify:!1}},e.step={value:null,resolve:Number(o.hash().split("-")[1]),check:function(e){return this.value===e},validate:function(t){var n=!0;switch(t){case 1:e.data.submitted=!0,e.data.validation.name.first=e.data.user.name.first=="",e.data.validation.name.last=e.data.user.name.last=="",e.data.validation.email=e.data.user.email=="",e.data.validation.passwords=e.data.passwords.first==""||e.data.passwords.second==""||e.data.passwords.first!=e.data.passwords.second;if(e.data.validation.first||e.data.validation.last||e.data.validation.email||e.data.validation.userExists||e.data.validation.passwords||!e.data.agreed)n=!1;break;case 2:break;case 3:break;default:}return n},forward:function(){var t=this.value,n=angular.element("body");n.removeClass();switch(t){case 1:n.addClass("register-0");break;case 2:n.addClass("register-1");break;case 3:n.addClass("register-2");break;case 4:n.addClass("register-3")}this.validate(t)&&(this.value=Number(t+1),o.hash("step-"+this.value)),e.data.verification.resent=!1,e.data.error.register=!1,e.data.error.resent=!1,e.data.error.verify=!1}},localStorage.hasOwnProperty("data.verification.id")&&(e.step.value=3,o.hash("step-3")),e.step.value=e.step.resolve,e.register=function(){r.caller("register",{name:e.data.user.name.full(),username:e.data.user.email,email:e.data.user.email,password:e.data.passwords.first,phone:e.data.user.phone,verification:"SMS"}).then(function(t){t.hasOwnProperty("error")?e.data.error.register=!0:(e.data.verification.id=t.verificationCode,localStorage.setItem("data.verification.id",t.verificationCode))})};var h=500;e.userExists=function(){e.checkUsername&&(clearTimeout(e.checkUsername),e.checkUsername=null),e.checkUsername=setTimeout(function(){e.checkUsername=null,e.registrationForm1.email.$valid&&r.caller("userExists",{username:e.data.user.email}).then(function(t){e.data.validation.userExists=t.hasOwnProperty("error")})},h)},e.checkUsername=null,e.verify=function(){r.caller("registerVerify",{code:e.data.verification.code,id:localStorage.getItem("data.verification.id")}).then(function(t){t.hasOwnProperty("error")?(e.data.verification.resent=!1,e.data.error.verify=!0):(localStorage.removeItem("data.verification.id"),e.step.forward(),e.sessionId=t["X-SESSION_ID"])})},e.forgotPass=function(){l.attr("disabled","disabled"),e.login.password="",r.caller("forgotPass",{third:e.login.email,guiForwardLink:o.absUrl()}).then(function(t){t.hasOwnProperty("error")?(e.login.notification="Something went wrong with the reset request, check the email address and try again",l.removeAttr("disabled")):(e.login.email="",e.login.notification="Password reset request sent succesfully, please check your email.",e.login.forgot=!1,l.removeAttr("disabled"),setTimeout(function(){e.$apply(function(e){e.login.notification=""})},5e3))})},e.changePass=function(){l.attr("disabled","disabled"),e.data.submitted=!0,e.data.validation.passwords=e.data.passwords.first==""||e.data.passwords.second==""||e.data.passwords.first!=e.data.passwords.second,e.data.validation.passwords?l.text("Submit New Password").removeAttr("disabled"):r.caller("changePass",{fourth:a,code:f,password:u(e.data.passwords.first)}).then(function(t){t.hasOwnProperty("error")?(l.removeAttr("disabled"),e.login.notification="Something went wrong when changing the password"):(e.login.notification="Password succesfully changed.",e.data.passwords={first:"",second:""},e.data.validation.passwords=!1,e.login.changePass=!1,l.removeAttr("disabled"),setTimeout(function(){e.$apply(function(e){e.login.notification=""})},5e3))})},e.resend=function(){r.caller("resendVerify",{code:localStorage.getItem("data.verification.id"),verification:"SMS"}).then(function(t){t.hasOwnProperty("error")?e.data.error.resent=!0:(e.data.verification.resent=!0,e.data.error.verify=!1)})},e.bootstrap=function(){i.set(e.sessionId,!0),r.caller("info").then(function(e){s("app").save({user:e}),t.user=e,o.path("/home")})}}])});