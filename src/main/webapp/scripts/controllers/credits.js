define(["controllers/controllers","modals/askfast"],function(e,t){"use strict";e.controller("credits",["$scope","$rootScope","$routeParams","$timeout","$location","$filter","AskFast","Session","Store","DTOptionsBuilder","DTColumnDefBuilder",function(e,t,n,r,i,s,o,u,a,f,l){function h(){o.caller("info").then(function(n){e.paypal.link=t.config.host+"/paymentserver/paypal?accountId="+n.id+"&redirect_url="+encodeURIComponent(i.absUrl()+"?redirect=successfulpaypal"),a("app").save({user:n}),t.user=n})}function p(){e.loading=!0,o.caller("getPayments").then(function(t){e.payments=t,e.loading=!1})}function d(t,n){e.infomessage=t,n!==!0&&r(function(){e.infomessage=""},5e3)}e.loading=!0,e.paypal={showButton:!1,link:""},e.payment={showCreditButton:!1,showCreditForm:!1,showCheckoutButton:!1,showConfirm:!1},e.infomessage="",e.order={},e.creditBuyOptions=function(){var e=[],t=100,n=10,r=n;while(r<=t)e.push({value:r,name:s("currency")(r,"€")}),r+=n;return e}();var c={};n.redirect==="successfulpaypal"&&d("Congratulations, your PayPal account is verified!"),h(),o.caller("paymentMethods").then(function(n){var r=[];angular.forEach(n,function(e){c[e.type]=e.id}),typeof c.PAYPAL!="undefined"?t.config.feature.paypal===!0&&r.push({name:"PayPal",value:"PAYPAL"}):e.paypal.showButton=!0,e.methods=r,r.length!==0&&(e.payment.showCreditButton=!0)}),p(),e.dtOptions=f.newOptions().withTableTools("../scripts/libs/datatables/1.10.4/extensions/TableTools/swf/copy_csv_xls_pdf.swf").withTableToolsButtons(["copy","print",{sExtends:"collection",sButtonText:"Save",aButtons:["csv","xls","pdf"]}]).withOption("order",[[0,"desc"]]),e.dtColumnDefs=[l.newColumnDef(0),l.newColumnDef(1),l.newColumnDef(2)],e.paymentform=function(){e.payment.showCreditButton=!1,e.payment.showCreditForm=!0,e.payment.showCheckoutButton=!0},e.proceedToCheckOut=function(){e.order&&e.order.amount&&e.order.method?(e.payment.showCheckoutButton=!1,angular.element(".order-option").attr("disabled","disabled"),e.payment.showConfirm=!0):d("Please select both an amount and a payment method.")},e.buycredits=function(t){d("Processing your request...",!0);var n=e.user.id;t&&typeof t.amount=="number"&&typeof t.method=="string"?o.caller("newPayment",null,{paymentMethodId:c[t.method],amount:t.amount}).then(function(t){angular.isDefined(t.id)&&angular.isDefined(t.amount)&&angular.isDefined(t.type)?(d("Your payment of "+s("currency")(t.amount,"€")+" was successful, thank you."),h(),p(),e.abortSale()):(d("Something went wrong with the transaction"),h(),p(),e.abortSale())},function(t){d("Something went wrong with the transaction"),h(),p(),e.abortSale()}):d("Please select both an amount and a payment method.")},e.abortSale=function(){angular.element(".order-option").removeAttr("disabled").val(null),e.order={},e.payment.showCreditButton=!0,e.payment.showCreditForm=!1,e.payment.showCheckoutButton=!1,e.payment.showConfirm=!1}}])});