define(["controllers/controllers"],function(e){"use strict";e.controller("core",["$rootScope","$scope","$q","$route","$location","$timeout","AskFast","Store","moment",function(e,t,n,r,i,s,o,u,a){function f(e,n,r){return e.start?(e.startString=a(e.start).format("HH:mm:ss Z YYYY-MM-DD"),e.duration!==null?e.endString=a(e.start+e.duration).format("HH:mm:ss Z YYYY-MM-DD"):e.endString="-"):(e.startString="-",e.endString="-"),e.fromAddress=e.fromAddress||"-",e.toAddress=e.toAddressString?Object.keys(angular.fromJson(e.toAddressString))[0]:"-",e.ddrTypeString=e.ddrTypeId?n[e.ddrTypeId].categoryString:"-",e.statusPerAddress&&angular.forEach(e.statusPerAddress,function(t,n){e.statusPerAddress[n]={index:n,status:t}}),e.adapterTypeString=e.adapterId?t.adapterTypes[r[e.adapterId]].label:"-",e}function l(e){t.Dialog.open(e)}u=u("data"),t.ddrId=null,t.currentSection="debugger",r.current.params.ddrId&&(t.currentSection="details",t.ddrId=r.current.params.ddrId),t.loading={logs:!0},t.setSection=function(e,n){r.current.params.ddrId&&(t.ddrId=null,i.url("/developer")),n&&(t.ddrId=null),t.currentSection=e,e==="debugger"&&(t.logs=[],t.Log.list())},t.$on("$routeUpdate",function(){r.current.params.ddrId&&t.ddrId===null?(t.ddrId=r.current.params.ddrId,t.currentSection="details",t.Log.detail(t.ddrId)):t.currentSection==="details"&&t.setSection("debugger",!0)}),t.types=["Phone","SMS","Gtalk","Email","Twitter"],t.adapterTypes={call:{label:"Phone",ids:[]},xmpp:{label:"Gtalk",ids:[]},email:{label:"Email",ids:[]},twitter:{label:"Twitter",ids:[]},sms:{label:"SMS",ids:[]}},t.channel={type:null,adapter:null},t.forms={},t.candidates=[],t.channelTypeSelected=function(){var e=[];angular.forEach(t.adapterTypes,function(n){n.label==t.channel.type&&angular.forEach(n.ids,function(n){angular.forEach(t.adapters,function(t){t.configId==n&&e.push(t)})})}),t.candidates=e},t.dialogAuth={open:!1,message:"",messageType:""},t.resetAdapterMenu=function(){t.channel.type=null,t.channel.adapter=null},t.query={category:"all",limit:100,until:a().format("DD/MM/YYYY")},t.Log={data:null,list:function(e){var n=e?e:a().endOf("day").valueOf();t.loading.logs=!0,o.caller("ddr",{limit:t.query.limit,endTime:n}).then(function(e){var n=u.get("ddrTypes"),r=u.get("adapterMap"),i={call:[],email:[],sms:[],xmpp:[],twitter:[]},s=[];angular.forEach(e,function(e){s.push(f(e,n,r))}),angular.forEach(s,function(e){angular.forEach(r,function(t,n){e.adapterId==n&&i[r[e.adapterId]]&&i[r[e.adapterId]].push(e)})}),this.data=i,this.categorize(),t.loading.logs=!1}.bind(this))},categorize:function(){var e=t.query.category;if(e&&e!=="all")t.logs=this.data[e];else{var n=[],r=this.data;angular.forEach(r,function(e){angular.forEach(e,function(e){n.push(e)})}),t.logs=n}},period:function(){this.list(a(t.query.until,"DD/MM/YYYY").endOf("day").valueOf())},detail:function(e){var r=u.get("ddrTypes"),i=u.get("adapterMap");n.all([o.caller("ddrRecord",{second:e}),o.caller("log",{ddrRecordId:e})]).then(function(e){t.ddrDetails=f(e[0],r,i);var n=e[1];angular.forEach(n,function(e){e.timestamp&&(e.timeString=a(e.timestamp).format("HH:mm:ss Z YYYY-MM-DD"))}),t.logs=n,s(function(){$(".ddr-detail .panel-collapse").collapse({toggle:!1})})},function(e){console.warn("error ",e)})}},t.ddrId?t.Log.detail(t.ddrId):t.Log.list(),t.Adapter={list:function(e){t.adapterType="",o.caller("getAdapters").then(function(n){angular.forEach(n,function(e){if(e.adapterType in t.adapterTypes){var n=t.adapterTypes[e.adapterType].ids;n.indexOf(e.configId)==-1&&n.push(e.configId)}}),u.save(t.adapterTypes,"adapterTypes"),t.adapters=n,e&&e.call(null,n)})},add:function(e){o.caller("createAdapter",{second:e.configId}).then(function(){this.list(),t.adapterType=""}.bind(this))},query:function(e){o.caller("freeAdapters",{adapterType:e}).then(function(e){t.freeAdapters=e})},remove:function(e){o.caller("removeAdapter",{second:e.configId}).then(function(){this.list()}.bind(this))}},t.Adapter.list(),t.Dialog={list:function(e){o.caller("getDialog").then(function(n){t.dialogs=n,t.loadingDialogs=!0,e&&e.call()})},add:function(e){e.form.name&&e.form.url&&o.caller("createDialog",null,{name:e.form.name,url:e.form.url}).then(function(e){t.addingDialog=!1,this.list(function(){t.setSection("dialogs"),l(e),t.dialogAuth=!1})}.bind(this))},remove:function(e){o.caller("deleteDialog",{third:e.id}).then(function(){t.addingDialog=!1,this.list(function(){t.dialog=null,t.dialogs[0]&&(t.dialog=t.dialogs[0]),t.setSection("dialogs")})}.bind(this))},update:function(e,t){var n={id:e.id,name:e.name,url:e.url,owner:e.owner};angular.isDefined(e.userName)&&angular.isDefined(e.password)&&angular.isDefined(e.useBasicAuth)&&(n.userName=e.userName,n.password=e.password,n.useBasicAuth=e.useBasicAuth),o.caller("updateDialog",{third:e.id},n).then(function(e){t&&(e.error?t.reject(e):t.resolve(e)),this.list()}.bind(this))},updateDetails:function(e){var n=t.dialogs.filter(function(t){return t.id===e.id?!0:!1});e.userName=n[0].userName,e.password=n[0].password,this.update(e)},adapters:{list:function(e,n){var r=[];return angular.forEach(t.adapters,function(t){n&&n.id==t.id?r.push(n):t.dialogId==e&&r.push(t)}),r},update:function(e,n){o.caller("updateAdapter",{second:n},{dialogId:e}).then(function(e){t.Adapter.list()}.bind(this))},add:function(e){this.update(e.id,t.channel.adapter),t.resetAdapterMenu(),t.candidates=[],l(e)},remove:function(e){this.update("",e.configId)}},open:function(e){t.dialog=angular.copy(e),t.Dialog.authentication.notify(null,null,!0),angular.isDefined(t.forms.details)&&(t.forms.details.$setPristine(),this.adapters.list(e.id)&&(t.dialogAdapters=this.adapters.list(e.id)))},authentication:{enable:function(e){if(!e.userName||!e.password){this.notify("Please fill in both a Username and a Password","warning");return}e.useBasicAuth=!0;var r=t.dialogs.filter(function(t){return t.id===e.id?!0:!1});e.name=r[0].name,e.url=r[0].url;var i=n.defer();t.Dialog.update(e,i),i.promise.then(function(e){t.dialogAuth.open=!1,this.notify("Basic Authentication applied successfully","success")}.bind(this)).catch(function(e){console.log("error -> ",e),this.notify("Something went wrong with the request","danger")}.bind(this))},disable:function(e){var r;e.useBasicAuth=!1;var i=t.dialogs.filter(function(t){return t.id===e.id?!0:!1});e.name=i[0].name,e.url=i[0].url,r=angular.copy(e),r.userName=null,r.password=null;var s=n.defer();t.Dialog.update(r,s),s.promise.then(function(e){t.dialogAuth.open=!1,this.notify("Basic Authentication successfully disabled","success")}.bind(t.Dialog.authentication)).catch(function(e){console.log("error -> ",e),this.notify("Something went wrong with the request","danger")}.bind(t.Dialog.authentication))},notify:function(e,n,r){r&&(t.dialogAuth.message=""),t.dialogAuth.message=e,t.dialogAuth.messageType=n,t.authNotifyTimeoutPromise&&s.cancel(t.authNotifyTimeoutPromise),t.authNotifyTimeoutPromise=s(function(){t.dialogAuth.message=""},6e3)},cancel:function(e){var n=t.dialogs.filter(function(t){return t.id===e.id?!0:!1});t.dialog.userName=n[0].userName,t.dialog.password=n[0].password,t.dialogAuth.open=!1,t.forms.auth.$setPristine()}}},t.authenticateDialog=function(e){t.Dialog.authentication.enable(e)},t.disableDialogAuthentication=function(e){t.Dialog.authentication.disable(e)},t.cancelAuthentication=function(e){t.Dialog.authentication.cancel(e)},t.expandAll=function(){$(".ddr-detail .panel-collapse").collapse("show")},t.collapseAll=function(){$(".ddr-detail .panel-collapse").collapse("hide")},t.Dialog.list(function(){t.dialogs.length>0&&t.Dialog.open(t.dialogs[0])})}])});