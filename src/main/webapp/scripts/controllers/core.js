define(["require","exports","controllers/controllers"],function(e,t,n){"use strict";var r=n.controller("core",["$rootScope","$q","$location","$timeout","AskFast","Store","moment",function(e,t,n,r,i,s,o){function a(e){u.Dialog.open(e)}s=s("data");var u=this;u.currentSection="dialogs",u.setSection=function(e){u.currentSection=e},u.types=["Phone","SMS","Gtalk","Email","Twitter"],u.adapterTypes={call:{label:"Phone",ids:[]},xmpp:{label:"Gtalk",ids:[]},email:{label:"Email",ids:[]},twitter:{label:"Twitter",ids:[]},sms:{label:"SMS",ids:[]}},u.channel={type:null,adapter:null},u.forms={},u.candidates=[],u.channelTypeSelected=function(){var e=[];angular.forEach(u.adapterTypes,function(t){t.label==u.channel.type&&angular.forEach(t.ids,function(t){angular.forEach(u.adapters,function(n){n.configId==t&&e.push(n)})})}),u.candidates=e},u.dialogAuth={open:!1,message:"",messageType:""},u.resetAdapterMenu=function(){u.channel.type=null,u.channel.adapter=null},u.Adapter={list:function(e){u.adapterType="",i.caller("getAdapters").then(function(t){angular.forEach(t,function(e){if(e.adapterType in u.adapterTypes){var t=u.adapterTypes[e.adapterType].ids;t.indexOf(e.configId)==-1&&t.push(e.configId)}}),s.save(u.adapterTypes,"adapterTypes"),u.adapters=t,e&&e.call(null,t)})},add:function(e){var t=this;i.caller("createAdapter",{second:e.configId}).then(function(){t.list(),u.adapterType=""})},updateDialog:function(e){var t=this;e.dialogId===null&&(e.dialogId=""),e.updateFeedback&&(e.updateFeedback=""),e.updateFeedback="glyphicon glyphicon-refresh",i.caller("updateAdapter",{second:e.configId},{dialogId:e.dialogId}).then(function(n){n.error?(e.updateFeedback="glyphicon glyphicon-exclamation-sign",t.errorNotification="Something went wrong, try again.If it keeps happening, please contact info@ask-fast.com. Response status: "+n.error.status):(e.dialogId=n.dialogId,e.updateFeedback="glyphicon glyphicon-ok-circle")})},errorNotification:"",query:function(e){i.caller("freeAdapters",{adapterType:e}).then(function(e){u.freeAdapters=e})},remove:function(e){var t=this;i.caller("removeAdapter",{second:e.configId}).then(function(){t.list()})}},u.Adapter.list(),u.Dialog={list:function(e){i.caller("getDialog").then(function(t){u.dialogs=t,u.loadingDialogs=!0,e&&e.call()})},add:function(e){var t=this;e.form.name&&e.form.url&&i.caller("createDialog",null,{name:e.form.name,url:e.form.url}).then(function(e){u.addingDialog=!1,t.list(function(){u.setSection("dialogs"),a(e),u.dialogAuth=!1})})},remove:function(e){var t=this;i.caller("deleteDialog",{third:e.id}).then(function(){u.addingDialog=!1,t.list(function(){u.dialog=null,u.dialogs[0]&&(u.dialog=u.dialogs[0]),u.setSection("dialogs")})})},update:function(e,t){var n=this,r={id:e.id,name:e.name,url:e.url,owner:e.owner};angular.isDefined(e.userName)&&angular.isDefined(e.password)&&angular.isDefined(e.useBasicAuth)&&(r.userName=e.userName,r.password=e.password,r.useBasicAuth=e.useBasicAuth),i.caller("updateDialog",{third:e.id},r).then(function(e){t&&(e.error?t.reject(e):t.resolve(e)),n.list()})},updateDetails:function(e){var t=u.dialogs.filter(function(t){return t.id===e.id?!0:!1});e.userName=t[0].userName,e.password=t[0].password,this.update(e)},adapters:{list:function(e,t){var n=[];return angular.forEach(u.adapters,function(r){t&&t.id==r.id?n.push(t):r.dialogId==e&&n.push(r)}),n},update:function(e,t){i.caller("updateAdapter",{second:t},{dialogId:e}).then(function(e){u.Adapter.list()})},add:function(e){this.update(e.id,u.channel.adapter),u.resetAdapterMenu(),u.candidates=[],a(e)},remove:function(e){this.update("",e.configId)}},open:function(e){u.dialog=angular.copy(e),u.Dialog.authentication.notify(null,null,!0),angular.isDefined(u.forms.details)&&(u.forms.details.$setPristine(),this.adapters.list(e.id)&&(u.dialogAdapters=this.adapters.list(e.id)))},authentication:{enable:function(e){var n=this;if(!e.userName||!e.password){this.notify("Please fill in both a Username and a Password","warning");return}e.useBasicAuth=!0;var r=u.dialogs.filter(function(t){return t.id===e.id?!0:!1});e.name=r[0].name,e.url=r[0].url;var i=t.defer();u.Dialog.update(e,i),i.promise.then(function(e){u.dialogAuth.open=!1,n.notify("Basic Authentication applied successfully","success")}).catch(function(e){console.log("error -> ",e),n.notify("Something went wrong with the request","danger")})},disable:function(e){var n=this,r;e.useBasicAuth=!1;var i=u.dialogs.filter(function(t){return t.id===e.id?!0:!1});e.name=i[0].name,e.url=i[0].url,r=angular.copy(e),r.userName=null,r.password=null;var s=t.defer();u.Dialog.update(r,s),s.promise.then(function(e){u.dialogAuth.open=!1,n.notify("Basic Authentication successfully disabled","success")}).catch(function(e){console.log("error -> ",e),n.notify("Something went wrong with the request","danger")})},notify:function(e,t,n){n&&(u.dialogAuth.message=""),u.dialogAuth.message=e,u.dialogAuth.messageType=t,u.authNotifyTimeoutPromise&&r.cancel(u.authNotifyTimeoutPromise),u.authNotifyTimeoutPromise=r(function(){u.dialogAuth.message=""},6e3)},cancel:function(e){var t=u.dialogs.filter(function(t){return t.id===e.id?!0:!1});u.dialog.userName=t[0].userName,u.dialog.password=t[0].password,u.dialogAuth.open=!1,u.forms.auth.$setPristine()}}},u.authenticateDialog=function(e){u.Dialog.authentication.enable(e)},u.disableDialogAuthentication=function(e){u.Dialog.authentication.disable(e)},u.cancelAuthentication=function(e){u.Dialog.authentication.cancel(e)},u.Dialog.list(function(){u.dialogs.length>0&&u.Dialog.open(u.dialogs[0])})}]);return r});